import{V as G,a as M,b as E,c as L,d as B}from"./VisualizationBuilder-d66444cb.js";import{_ as Y,af as w,l as u,m,p as e,q as i,V as U,v as N,x as o,M as y,y as _,z as f,H as P,B as x,G as V,A as j,C as g,D as k,F as b,I as H,aX as O,J,ag as C,aA as q,az as R,N as T,K as A,a_ as F,aw as K,b4 as X,b5 as Q}from"./index-e36d139d.js";import{V as Z}from"./VContainer-e49a59e2.js";import{V as v}from"./VCol-9fd26098.js";const $={props:{edit:{type:Boolean,default:!1}},data(){return{dashboards:[],loadingDashData:!1,editingDash:!1,visualizations:[],dimensions:[],displayVizList:!1,loadingAvailableVizs:!1,availableViz:[],hardRerenderViz:0,title:"",dashboardId:"",chart_layout:{},showValuesSelector:!1,filters:[],activeDimension:{dimValues:[],selectedValues:[],filterCondition:"include",data:"",loading:!1}}},watch:{activeDimension:{handler(){if(!this.activeDimension.data.name)return;const l=this.filters.findIndex(n=>n.name===this.activeDimension.data.name),t={name:this.activeDimension.data.name,display:this.activeDimension.data.display,values:this.activeDimension.selectedValues,type:this.activeDimension.data.type,filterCondition:this.activeDimension.filterCondition};this.activeDimension.selectedValues.length===0?l>-1&&this.filters.splice(l,1):l===-1?this.filters.push(t):this.filters[l]=t},deep:!0}},computed:{canSave(){return!!(this.visualizations.length>0&&this.title)},draggable(){return!!this.editingDash},resizable(){return!!this.editingDash}},methods:{listDashboard(){this.dashboards=[],this.loading=!0,this.displayDashList=!0,this.getDashboards().then(()=>{this.loading=!1})},getDashboards(l){return new Promise((t,n)=>{l||(l="/fhir/Basic?_profile=http://ihris.org/fhir/StructureDefinition/ihris-dashboard"),fetch(l).then(c=>{c.json().then(a=>{for(const h of a.entry){const p=h.resource.extension.find(z=>z.url==="http://ihris.org/fhir/StructureDefinition/ihris-basic-name");p&&this.dashboards.push({id:h.resource.id,name:p.valueString})}const r=a.link.find(h=>h.relation==="next");if(r)this.getDashboards(r.url).then(()=>t()).catch(h=>n(h));else return t()})})})},cancelEditing(){this.dashboardId?this.editingDash=!1:this.$router.push({name:"home"})},applyFilters(){this.showValuesSelector=!1,this.reloadAllViz(),this.activeDimension.data={}},removeFilter(l,t){this.filters[l].values.splice(t,1),this.filters[l].values.length===0&&this.filters.splice(l,1),this.reloadAllViz()},reloadAllViz(){this.hardRerenderViz++},activateDimension(l){this.showValuesSelector=!0,this.activeDimension.loading=!0,this.activeDimension.dimValues=[],this.activeDimension.selectedValues=[],this.activeDimension.filterCondition="include";const t=this.filters.find(c=>c.name===this.activeDimension.data.name);t&&(this.activeDimension.filterCondition=t.filterCondition,this.activeDimension.selectedValues=JSON.parse(JSON.stringify(t.values)));const n=`/es/populateFilter/${l.dataset.name}/${l.name}?dataType=${l.type}`;fetch(n,{method:"GET"}).then(c=>{c.json().then(a=>{this.activeDimension.loading=!1;for(const r of a)this.activeDimension.dimValues.push({name:r.key.value})})})},popDimensions(l){for(const t of l.data)this.dimensions.find(c=>c.name===t.name)||(t.dataset=l.dataset,this.dimensions.push(t))},getDashboard(){this.loadingDashData=!0,this.visualizations=[],fetch("/fhir/Basic/"+this.dashboardId).then(l=>{l.json().then(t=>{this.loadingDashData=!1;for(const n of t.extension)if(n.url==="http://ihris.org/fhir/StructureDefinition/ihris-basic-name"&&(this.title=n.valueString),n.url==="http://ihris.org/fhir/StructureDefinition/ihris-dashboard-visualization"){const c=n.extension.find(d=>d.url==="vizID").valueString,a=n.extension.find(d=>d.url==="horizontal").valueDecimal,r=n.extension.find(d=>d.url==="vertical").valueDecimal,h=n.extension.find(d=>d.url==="width").valueDecimal,p=n.extension.find(d=>d.url==="height").valueDecimal,z=n.extension.find(d=>d.url==="heightPx").valueDecimal,S=n.extension.find(d=>d.url==="itemID").valueInteger,s=n.extension.find(d=>d.url==="static").valueBoolean;this.visualizations.push({id:c,x:a,y:r,w:h,h:p,hPx:z,i:S,static:s})}})})},resizeEvent:function(l,t,n,c,a){const r=this.visualizations.find(h=>h.i===l);r.hPx=c-36,r.rerender++},resizedEvent(l,t,n,c,a){const r=this.visualizations.find(h=>h.i===l);r.hPx=c-36,r.rerender++},listViz(){this.loadingAvailableVizs=!0,this.displayVizList=!0,this.getViz().then(()=>{this.loadingAvailableVizs=!1})},getViz(l){return new Promise((t,n)=>{this.availableViz=[],l||(l="/fhir/Basic?_profile=http://ihris.org/fhir/StructureDefinition/ihris-data-visualization"),fetch(l).then(c=>{c.json().then(a=>{for(const h of a.entry){const p=h.resource.extension.find(z=>z.url==="http://ihris.org/fhir/StructureDefinition/ihris-basic-name");p&&this.availableViz.push({id:h.resource.id,name:p.valueString})}const r=a.link.find(h=>h.relation==="next");if(r)this.getViz(r.url).then(()=>t()).catch(h=>n(h));else return t()})})})},addVizualization(l){let t=0;for(const n of this.visualizations)n.y>t&&(t=n.y);t&&(t+=2),this.visualizations.push({id:l,x:0,y:t,w:6,h:11.2,hPx:400,i:this.visualizations.length,static:!1,rerender:0})},save(){const l={resourceType:"Basic",meta:{profile:["http://ihris.org/fhir/StructureDefinition/ihris-dashboard"]},code:{coding:[{code:"visualization",system:"http://ihris.org/fhir/CodeSystem/ihris-resource-codesystem"}]},extension:[{url:"http://ihris.org/fhir/StructureDefinition/ihris-basic-name",valueString:this.title}]};for(const n of this.visualizations)l.extension.push({url:"http://ihris.org/fhir/StructureDefinition/ihris-dashboard-visualization",extension:[{url:"vizID",valueString:n.id},{url:"horizontal",valueDecimal:n.x},{url:"vertical",valueDecimal:n.y},{url:"width",valueDecimal:n.w},{url:"height",valueDecimal:n.h},{url:"heightPx",valueDecimal:n.hPx},{url:"itemID",valueInteger:n.i},{url:"static",valueBoolean:n.static}]});let t="POST";this.dashboardId?(t="PUT",l.id=this.dashboardId):this.dashboardId="",fetch("/fhir/Basic/"+this.dashboardId,{method:t,headers:{"Content-Type":"application/json"},body:JSON.stringify(l)}).then(n=>{if(n.status!==200&&n.status!==201){this.$store.state.snackbar.enabled=!0,this.$store.state.snackbar.text="Failed to save Dashboard!",this.$store.state.snackbar.color="error";return}n.json().then(c=>{this.$store.state.snackbar.enabled=!0,this.$store.state.snackbar.text="Dashboard saved successfully!",this.$store.state.snackbar.color="primary",this.dashboardId=c.id})}).catch(n=>{this.$store.state.snackbar.enabled=!0,this.$store.state.snackbar.text="Failed to save Dashboard!",this.$store.state.snackbar.color="error",console.error("Error:",n)})},removeViz(l){const t=this.visualizations.findIndex(n=>n.i===l);t>-1&&this.visualizations.splice(t,1)},reload(){this.dashboardId?this.getDashboard():this.visualizations=[]}},created(){this.$route.params.id||(this.editingDash=!0),this.dashboardId=this.$route.params.id,this.dashboardId&&this.getDashboard(),this.listDashboard()},components:{VisualizationBuilder:G}},ee=T("br",null,null,-1),ie=T("br",null,null,-1),te={style:{"font-size":"13px",cursor:"pointer"}},ae={key:1,style:{"text-align":"center"}};function se(l,t,n,c,a,r){const h=w("v-data-table"),p=w("VisualizationBuilder"),z=w("grid-item"),S=w("grid-layout");return u(),m(Z,{fluid:""},{default:e(()=>[i(H,{persistent:"",transition:"dialog-top-transition",modelValue:a.showValuesSelector,"onUpdate:modelValue":t[3]||(t[3]=s=>a.showValuesSelector=s),width:"560px"},{default:e(()=>[i(U,{color:"primary",density:"compact",height:"40px"},{default:e(()=>[i(N,null,{default:e(()=>[o(" Values For "+y(a.activeDimension.data.display),1)]),_:1}),i(_),i(f,{onClick:t[0]||(t[0]=s=>a.showValuesSelector=!1),style:{cursor:"pointer"}},{default:e(()=>[o("mdi-close")]),_:1})]),_:1}),i(P,{class:"overflow-auto"},{default:e(()=>[i(x,null,{default:e(()=>[i(v,{cols:"auto"},{default:e(()=>[ee,i(M,{inline:"",modelValue:a.activeDimension.filterCondition,"onUpdate:modelValue":t[1]||(t[1]=s=>a.activeDimension.filterCondition=s)},{default:e(()=>[i(E,{label:"Include",value:"include"}),i(E,{label:"Exclude",value:"exclude"})]),_:1},8,["modelValue"])]),_:1}),i(_),i(v,{cols:"2"},{default:e(()=>[ie,i(V,{color:"accent",size:"small",onClick:r.applyFilters},{default:e(()=>[o(" Apply ")]),_:1},8,["onClick"])]),_:1})]),_:1}),i(j,null,{default:e(()=>[(u(!0),g(b,null,k(a.filters,(s,d)=>(u(),g(b,null,[s.name===a.activeDimension.data.name?(u(!0),g(b,{key:0},k(s.values,(D,I)=>(u(),m(R,{key:D.name,color:"green","text-color":"red",variant:"outlined",closable:"","onClick:close":W=>r.removeFilter(d,I)},{default:e(()=>[o(y(D.name),1)]),_:2},1032,["onClick:close"]))),128)):C("",!0)],64))),256)),i(h,{"hide-default-header":"","items-per-page":27,headers:[{value:"name"}],items:a.activeDimension.dimValues,loading:a.activeDimension.loading,dense:"","item-key":"name","show-select":"",modelValue:a.activeDimension.selectedValues,"onUpdate:modelValue":t[2]||(t[2]=s=>a.activeDimension.selectedValues=s)},null,8,["items","loading","modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),i(H,{transition:"dialog-top-transition",modelValue:a.displayVizList,"onUpdate:modelValue":t[5]||(t[5]=s=>a.displayVizList=s),width:"960px"},{default:e(()=>[i(U,{color:"primary",density:"compact",height:"40px"},{default:e(()=>[i(N,null,{default:e(()=>[o(" Available Vizualizations ")]),_:1}),i(_),i(f,{onClick:t[4]||(t[4]=s=>a.displayVizList=!1),style:{cursor:"pointer"}},{default:e(()=>[o("mdi-close")]),_:1})]),_:1}),i(O,{indeterminate:a.loadingAvailableVizs,active:a.loadingAvailableVizs,color:"secondary"},null,8,["indeterminate","active"]),i(P,null,{default:e(()=>[i(j,null,{default:e(()=>[a.availableViz.length>0?(u(),m(J,{key:0,shaped:"",density:"compact"},{default:e(()=>[(u(!0),g(b,null,k(this.availableViz,(s,d)=>(u(),m(A,{key:d,onClick:D=>r.addVizualization(s.id)},{prepend:e(()=>[i(f,{icon:"mdi-menu-right"})]),default:e(()=>[i(F,null,{default:e(()=>[T("label",te,y(s.name),1)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:1})):C("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"]),i(x,null,{default:e(()=>[i(v,{cols:"12"},{default:e(()=>[i(x,null,{default:e(()=>[i(_),a.editingDash?(u(),m(v,{key:0,cols:"auto"},{default:e(()=>[i(V,{color:"tertiary",size:"small",onClick:t[6]||(t[6]=s=>l.$router.push({name:"home"}))},{default:e(()=>[i(f,{start:"",color:"primary"},{default:e(()=>[o("mdi-home")]),_:1}),o(" Home ")]),_:1}),o("   "),i(V,{color:"tertiary",size:"small",onClick:r.reload},{default:e(()=>[i(f,{start:"",color:"primary"},{default:e(()=>[o("mdi-reload")]),_:1}),o(" Reload ")]),_:1},8,["onClick"]),o("   "),i(V,{color:"tertiary",size:"small",onClick:r.save,disabled:!r.canSave},{default:e(()=>[i(f,{start:"",color:"primary"},{default:e(()=>[o("mdi-content-save-check")]),_:1}),o(" Save ")]),_:1},8,["onClick","disabled"]),o("   "),i(V,{color:"tertiary",size:"small",onClick:r.listViz},{default:e(()=>[i(f,{start:"",color:"primary"},{default:e(()=>[o("mdi-plus")]),_:1}),o(" Insert Visualization ")]),_:1},8,["onClick"]),o("   "),i(V,{color:"tertiary",size:"small",onClick:t[7]||(t[7]=s=>l.$router.push({name:"vizBuilder"}))},{default:e(()=>[i(f,{start:"",color:"primary"},{default:e(()=>[o("mdi-plus")]),_:1}),o(" Create Visualization ")]),_:1})]),_:1})):C("",!0)]),_:1})]),_:1}),i(v,{cols:"12"},{default:e(()=>[i(x,null,{default:e(()=>[i(v,{cols:"2"},{default:e(()=>[a.editingDash?(u(),m(q,{key:0,label:"Dashboard Title*",outlined:"",modelValue:a.title,"onUpdate:modelValue":t[8]||(t[8]=s=>a.title=s)},null,8,["modelValue"])):(u(),m(R,{key:1,variant:"outlined",label:"",size:"large"},{default:e(()=>[o(y(a.title),1)]),_:1}))]),_:1}),i(v,{cols:"2"},{default:e(()=>[i(L,{size:"10",width:"30",modelValue:a.activeDimension.data,"onUpdate:modelValue":[t[9]||(t[9]=s=>a.activeDimension.data=s),r.activateDimension],items:a.dimensions,"item-title":"display","item-value":"name","return-object":"",clearable:"",label:"Filter By",density:"compact"},null,8,["modelValue","items","onUpdate:modelValue"])]),_:1}),a.editingDash?(u(),m(v,{key:1,cols:"auto"},{default:e(()=>[i(V,{icon:"",color:"white",size:"small",onClick:r.cancelEditing},{default:e(()=>[i(f,{color:"error"},{default:e(()=>[o("mdi-close-thick")]),_:1}),i(B,{activator:"parent",location:"top"},{default:e(()=>[o(" Cancel Editing ")]),_:1})]),_:1},8,["onClick"])]),_:1})):(u(),m(v,{key:0,cols:"auto"},{default:e(()=>[i(V,{icon:"",color:"tertiary",size:"small",onClick:t[10]||(t[10]=s=>a.editingDash=!0)},{default:e(()=>[i(f,{color:"primary"},{default:e(()=>[o("mdi-pencil")]),_:1}),i(B,{activator:"parent",location:"top"},{default:e(()=>[o(" Edit this dashboard ")]),_:1})]),_:1})]),_:1})),i(_),i(v,{cols:"3"},{default:e(()=>[i(x,null,{default:e(()=>[i(v,{cols:"9"},{default:e(()=>[i(L,{modelValue:a.dashboardId,"onUpdate:modelValue":[t[11]||(t[11]=s=>a.dashboardId=s),t[12]||(t[12]=s=>l.$router.push({name:"dashBuilder",params:{edit:!1,id:a.dashboardId}}))],items:a.dashboards,"item-title":"name","item-value":"id",filled:"",density:"compact",label:"Other Dashboards"},null,8,["modelValue","items"])]),_:1}),a.dashboardId?(u(),m(v,{key:0,cols:"3"},{default:e(()=>[i(V,{icon:"",dark:"",color:"indigo",size:"small",onClick:t[13]||(t[13]=s=>l.$router.push({name:"dashBuilder",params:{edit:!0}}))},{default:e(()=>[i(f,null,{default:e(()=>[o("mdi-plus")]),_:1}),i(B,{activator:"parent",location:"top"},{default:e(()=>[o(" Add New Dashboard ")]),_:1})]),_:1})]),_:1})):C("",!0)]),_:1})]),_:1})]),_:1}),(u(!0),g(b,null,k(a.filters,(s,d)=>(u(),g(b,null,[(u(!0),g(b,null,k(s.values,(D,I)=>(u(),m(R,{key:D.name,class:"ma-2",color:"green","text-color":"red",variant:"outlined",closable:"","onClick:close":W=>r.removeFilter(d,I)},{default:e(()=>[o(y(s.display)+": "+y(D.name),1)]),_:2},1032,["onClick:close"]))),128))],64))),256)),a.loadingDashData?(u(),m(O,{key:0,indeterminate:!0})):a.visualizations.length===0?(u(),g("div",ae," Your dashboard is blank. Click Add Visualization button to add dashboard items ")):C("",!0),i(S,{layout:a.visualizations,"onUpdate:layout":t[14]||(t[14]=s=>a.visualizations=s),"col-num":14,"row-height":30,"is-draggable":r.draggable,"is-resizable":r.resizable,responsive:!1,restoreOnDrag:!0,"vertical-compact":!1,"prevent-collision":!1,"use-css-transforms":!0},{default:e(()=>[(u(!0),g(b,null,k(a.visualizations,s=>(u(),m(z,{static:s.static,x:s.x,y:s.y,w:s.w,h:s.h,i:s.i,key:s.i,onResize:r.resizeEvent,onResized:r.resizedEvent},{default:e(()=>[i(P,{height:s.hPx+37},{default:e(()=>[i(K,{transition:"slide-y-transition",rounded:"b-xl","close-on-content-click":!1},{activator:e(({props:d})=>[i(f,X(Q(d)),{default:e(()=>[o("mdi-dots-horizontal")]),_:2},1040)]),default:e(()=>[i(J,{rounded:"",dense:""},{default:e(()=>[i(A,{link:"",onClick:d=>r.removeViz(s.i)},{prepend:e(()=>[i(f,{size:"small",icon:"mdi-minus"})]),default:e(()=>[i(F,null,{default:e(()=>[o(" Remove Visualization ")]),_:1})]),_:2},1032,["onClick"]),i(A,{link:"",onClick:d=>l.$router.push({path:"/vizBuilder/"+s.id})},{prepend:e(()=>[i(f,{icon:"mdi-pencil"})]),default:e(()=>[i(F,null,{default:e(()=>[o("Edit")]),_:1})]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024),i(p,{id:s.id,softRerenderViz:s.rerender,hardRerenderViz:a.hardRerenderViz,vizHeight:s.hPx,editingViz:!1,externalFilters:a.filters,onDimensions:r.popDimensions},null,8,["id","softRerenderViz","hardRerenderViz","vizHeight","externalFilters","onDimensions"])]),_:2},1032,["height"])]),_:2},1032,["static","x","y","w","h","i","onResize","onResized"]))),128))]),_:1},8,["layout","is-draggable","is-resizable"])]),_:1})]),_:1})]),_:1})}const de=Y($,[["render",se]]);export{de as default};
